import { useEffect, useState } from "react";
import { useSearchParams } from "react-router-dom";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Input } from "@/components/ui/input";
import api from "@/lib/api";
import { useToast } from "@/hooks/use-toast";
import { Badge } from "@/components/ui/badge";
import { Popover, PopoverContent, PopoverTrigger } from "@/components/ui/popover";
import { Filter, RefreshCw, Plus, History, CheckCircle, XCircle, IndianRupee, X } from "lucide-react";
import { useAuth } from "@/contexts/AuthContext";
import { ExportFeesDialog } from "@/components/fees/ExportFeesDialog";
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from "@/components/ui/dialog";
import { Label } from "@/components/ui/label";

const Fees = () => {
  const [searchParams] = useSearchParams();
  const [fees, setFees] = useState<any[]>([]);
  const [students, setStudents] = useState<any[]>([]);
  const [selectedMonth, setSelectedMonth] = useState(new Date().getMonth() + 1);
  const [selectedYear, setSelectedYear] = useState(new Date().getFullYear());
  const [loading, setLoading] = useState(true);
  const [statusFilter, setStatusFilter] = useState("all");
  const [searchTerm, setSearchTerm] = useState("");
  const [partialPaymentOpen, setPartialPaymentOpen] = useState(false);

  // ... (lines omitted)

  // ... in the return JSX ...
  {
    fees.filter(fee => {
      const student = getStudent(fee.student);
      if (!student) return false;

      const matchesSearch = student.name.toLowerCase().includes(searchTerm.toLowerCase());
      const matchesStatus = statusFilter === "all" || fee.status === statusFilter;

      return matchesSearch && matchesStatus;
    }).map((fee) => {
      const student = getStudent(fee.student);
      if (!student) return null;

      const feeAmount = student.fee_structure === '4_classes_1000' ? 1000 : 700;

      return (
        <div
          key={fee.id}
          className="flex flex-col gap-3 p-3 sm:p-4 border border-border rounded-lg hover:bg-accent/10 transition-colors"
        >
          <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
            <div className="flex-1 min-w-0">
              <h3 className="font-semibold text-sm sm:text-base truncate">{student.name}</h3>
              <p className="text-xs sm:text-sm text-muted-foreground">
                Total Amount: ₹{feeAmount.toFixed(2)}
                {fee.paid_date && ` • Paid on ${new Date(fee.paid_date).toLocaleDateString()}`}
              </p>
            </div>
            {isAdmin && (
              <div className="flex gap-2 items-center">
                {/* Payment history button FIRST */}
                {fee.payment_history && Array.isArray(fee.payment_history) && fee.payment_history.length > 0 &&
                  (() => {
                    const currentDate = new Date();
                    const currentYear = currentDate.getFullYear();
                    const currentMonth = currentDate.getMonth() + 1;
                    const isFutureMonth = fee.year > currentYear || (fee.year === currentYear && fee.month > currentMonth);
                    return !isFutureMonth;
                  })() && (
                    <Popover>
                      <PopoverTrigger asChild>
                        <Button size="sm" variant="ghost" className="h-10 w-10 p-0">
                          <History className="h-4 w-4" />
                        </Button>
                      </PopoverTrigger>
                      <PopoverContent className="w-64">
                        <div className="space-y-2">
                          <h4 className="font-semibold text-sm">Payment History</h4>
                          <div className="space-y-1">
                            {fee.payment_history.map((payment: any, idx: number) => {
                              const paymentDate = new Date(payment.date);
                              return (
                                <div key={idx} className="flex justify-between text-xs border-b pb-1">
                                  <span className="text-muted-foreground">
                                    {paymentDate.getDate()} {paymentDate.toLocaleDateString('en-IN', { month: 'short' })} {paymentDate.getFullYear()}
                                  </span>
                                  <span className="font-semibold">₹{payment.amount}</span>
                                </div>
                              );
                            })}
                          </div>
                        </div>
                      </PopoverContent>
                    </Popover>
                  )}
                {/* Status dropdown */}
                <Select
                  value={fee.status}
                  onValueChange={(value) => {
                    if (value === 'partial') {
                      setSelectedFeeForPartial(fee);
                      setPartialAmountInput(fee.partial_amount_paid ? fee.partial_amount_paid.toString() : "");
                      setPartialPaymentOpen(true);
                    } else {
                      updateFeeStatus(fee.id, value, feeAmount);
                    }
                  }}
                >
                  <SelectTrigger className={`w-full sm:w-32 ${fee.status === 'paid' ? 'border-green-500 text-green-700 bg-green-50' :
                    fee.status === 'unpaid' ? 'border-red-500 text-red-700 bg-red-50' :
                      'border-orange-500 text-orange-700 bg-orange-50'
                    }`}>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="unpaid" className="text-red-700">
                      <span className="flex items-center gap-2">
                        <span className="w-2 h-2 rounded-full bg-red-500"></span>
                        Unpaid
                      </span>
                    </SelectItem>
                    <SelectItem value="paid" className="text-green-700">
                      <span className="flex items-center gap-2">
                        <span className="w-2 h-2 rounded-full bg-green-500"></span>
                        Paid
                      </span>
                    </SelectItem>
                    <SelectItem value="partial" className="text-orange-700">
                      <span className="flex items-center gap-2">
                        <span className="w-2 h-2 rounded-full bg-orange-500"></span>
                        Partial
                      </span>
                    </SelectItem>
                  </SelectContent>
                </Select>
              </div>
            )}
          </div>
          {fee.status === 'partial' && (
            <div className="flex gap-4 mt-2 text-sm items-center">
              <p className="text-muted-foreground">
                Paid: <span className="font-semibold text-green-600">₹{fee.partial_amount_paid || 0}</span>
              </p>
              <p className="text-muted-foreground">
                Remaining: <span className="font-semibold text-red-600">₹{feeAmount - (fee.partial_amount_paid || 0)}</span>
              </p>
              {isAdmin && (
                <div className="ml-auto flex gap-2">
                  <Button
                    size="sm"
                    variant="ghost"
                    className="h-8 w-8 p-0"
                    onClick={() => {
                      setSelectedFeeForPartial(fee);
                      setPartialAmountInput("");
                      setPartialPaymentOpen(true);
                    }}
                  >
                    <Plus className="h-4 w-4" />
                  </Button>
                </div>
              )}
            </div>
          )}
        </div>
      );
    })
  }
          </div >
        </CardContent >
      </Card >

  <Dialog open={partialPaymentOpen} onOpenChange={setPartialPaymentOpen}>
    <DialogContent>
      <DialogHeader>
        <DialogTitle>Add Partial Payment</DialogTitle>
      </DialogHeader>
      <div className="space-y-4">
        {selectedFeeForPartial && (() => {
          const student = students.find(s => s.id === selectedFeeForPartial.student);
          const totalFee = student?.fee_structure === '4_classes_1000' ? 1000 : 700;
          const currentPaid = parseFloat(selectedFeeForPartial.partial_amount_paid || "0");
          const remaining = totalFee - currentPaid;

          return (
            <>
              <div className="space-y-2 p-3 bg-muted rounded-lg">
                <div className="flex justify-between text-sm">
                  <span className="text-muted-foreground">Total Fee:</span>
                  <span className="font-semibold">₹{totalFee}</span>
                </div>
                <div className="flex justify-between text-sm">
                  <span className="text-muted-foreground">Already Paid:</span>
                  <span className="font-semibold text-green-600">₹{currentPaid}</span>
                </div>
                <div className="flex justify-between text-sm border-t pt-2">
                  <span className="text-muted-foreground">Remaining:</span>
                  <span className="font-bold text-red-600">₹{remaining}</span>
                </div>
              </div>
              <div>
                <Label>Add Payment Amount</Label>
                <Input
                  type="number"
                  placeholder={`Enter amount (max ₹${remaining})`}
                  value={partialAmountInput}
                  onChange={(e) => setPartialAmountInput(e.target.value)}
                />
              </div>
            </>
          );
        })()}
      </div>
      <DialogFooter>
        <Button variant="outline" onClick={() => setPartialPaymentOpen(false)}>Cancel</Button>
        <Button onClick={handlePartialPayment}>Add Payment</Button>
      </DialogFooter>
    </DialogContent>
  </Dialog>
    </div >
  );
};

export default Fees;
